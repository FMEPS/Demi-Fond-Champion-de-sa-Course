<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Champion de sa Course</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
            position: relative;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }

        h2 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-home {
            background: #ff6b6b;
            color: white;
            margin-bottom: 20px;
        }

        .btn-home:hover {
            background: #ee5a52;
        }

        .badge-selection, .allure-selection {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .badge-card, .allure-card {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .badge-card:hover, .allure-card:hover {
            border-color: #667eea;
            transform: scale(1.02);
        }

        .badge-card.selected, .allure-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .pause-bars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .pause-bar {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .pause-bar:hover {
            border-color: #667eea;
        }

        .pause-bar.pause {
            background: #ffd93d;
            border-color: #ffd93d;
            color: #333;
        }

        .chrono {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .observation-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .counter-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .counter-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-counter {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-plus {
            background: #51cf66;
            color: white;
        }

        .btn-minus {
            background: #ff6b6b;
            color: white;
        }

        .btn-counter:hover {
            transform: scale(1.1);
        }

        .counter-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            min-width: 60px;
            text-align: center;
        }

        .pause-notice {
            background: #ffd93d;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }

        .info-box {
            background: #e7f5ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .graph-container {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 15px;
        }

        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #555;
        }

        .result-value {
            font-weight: bold;
            color: #667eea;
        }

        .message-box {
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }

        .message-success {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
        }

        .message-retry {
            background: linear-gradient(135deg, #ffd93d 0%, #fab005 100%);
            color: #333;
        }

        .hidden {
            display: none;
        }

        .tranche-info {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #764ba2;
            margin: 15px 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .chrono {
                font-size: 24px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .intermittent-counter {
            text-align: center;
            font-size: 18px;
            margin: 15px 0;
            padding: 15px;
            background: #e7f5ff;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page 1: Accueil -->
        <div id="page-accueil" class="page">
            <h1>üèÉ Champion de sa Course</h1>
            
            <div class="input-group">
                <label for="coureur">Nom du Coureur</label>
                <input type="text" id="coureur" placeholder="Entrez le nom du coureur">
            </div>

            <div class="input-group">
                <label for="vma">VMA (km/h)</label>
                <input type="number" id="vma" placeholder="Ex: 12" min="6" max="20" step="0.5">
            </div>

            <div class="input-group">
                <label for="observateur">Nom de l'Observateur</label>
                <input type="text" id="observateur" placeholder="Entrez le nom de l'observateur">
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="nextPage('page-badge')">Suivant</button>
            </div>
        </div>

        <!-- Page 2: S√©lection du Badge -->
        <div id="page-badge" class="page hidden">
            <button class="btn-home" onclick="confirmHome()">üè† Accueil</button>
            <h2>S√©lection du Badge</h2>
            
            <div class="badge-selection">
                <div class="badge-card" onclick="selectBadge(6)">
                    <h3>ü•â Badge 6 min</h3>
                    <p>4 tranches de 1'30</p>
                </div>
                <div class="badge-card" onclick="selectBadge(9)">
                    <h3>ü•à Badge 9 min</h3>
                    <p>6 tranches de 1'30</p>
                </div>
                <div class="badge-card" onclick="selectBadge(12)">
                    <h3>ü•á Badge 12 min</h3>
                    <p>8 tranches de 1'30</p>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="prevPage('page-accueil')">Pr√©c√©dent</button>
                <button class="btn-primary" onclick="nextPage('page-allure')">Suivant</button>
            </div>
        </div>

        <!-- Page 3: S√©lection de l'Allure -->
        <div id="page-allure" class="page hidden">
            <button class="btn-home" onclick="confirmHome()">üè† Accueil</button>
            <h2>S√©lection de l'Allure</h2>
            
            <div class="allure-selection">
                <div class="allure-card" onclick="selectAllure('verte')">
                    <h3>üü¢ Allure Verte</h3>
                    <p>VMA - 3</p>
                    <p>Sans pause</p>
                </div>
                <div class="allure-card" onclick="selectAllure('jaune')">
                    <h3>üü° Allure Jaune</h3>
                    <p>VMA - 2</p>
                    <p>1 pause</p>
                </div>
                <div class="allure-card" id="allure-orange" onclick="selectAllure('orange')">
                    <h3>üü† Allure Orange</h3>
                    <p>VMA - 1</p>
                    <p>2 pauses</p>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="prevPage('page-badge')">Pr√©c√©dent</button>
                <button class="btn-primary" onclick="handleAllureNext()">Suivant</button>
            </div>
        </div>

        <!-- Page 4: S√©lection des Pauses -->
        <div id="page-pauses" class="page hidden">
            <button class="btn-home" onclick="confirmHome()">üè† Accueil</button>
            <h2>S√©lection des Pauses</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                Cliquez sur les tranches o√π vous souhaitez placer les pauses
            </p>
            
            <div id="pause-bars" class="pause-bars"></div>

            <div class="button-group">
                <button class="btn-secondary" onclick="prevPage('page-allure')">Pr√©c√©dent</button>
                <button class="btn-primary" onclick="startCourse()">Suivant</button>
            </div>
        </div>

        <!-- Page 5: Observation Course 1 -->
        <div id="page-observation1" class="page hidden">
            <button class="btn-home" onclick="confirmHome()">üè† Accueil</button>
            
            <div class="chrono" id="chrono1">00:00</div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="start-chrono1-btn" class="btn-primary" onclick="startChronoManually('chrono1', 1)">‚ñ∂Ô∏è D√©marrer le chronom√®tre</button>
            </div>
            
            <div class="tranche-info">
                Tranche <span id="tranche-num">1</span>/<span id="tranche-total">4</span>
            </div>

            <div id="observation-content">
                <div class="observation-panel">
                    <div class="info-box">
                        <strong>Plots cible:</strong> <span id="plots-cible">9</span>
                    </div>

                    <div class="counter-group">
                        <span class="result-label">Plots franchis</span>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="counter-buttons">
                                <button class="btn-counter btn-minus" onclick="changePlots(-1)">‚àí</button>
                                <button class="btn-counter btn-plus" onclick="changePlots(1)">+</button>
                            </div>
                            <span class="counter-value" id="plots-count">0</span>
                        </div>
                    </div>

                    <div class="counter-group">
                        <span class="result-label">P√©nalit√©s</span>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="counter-buttons">
                                <button class="btn-counter btn-minus" onclick="changePenalites(-1)">‚àí</button>
                                <button class="btn-counter btn-plus" onclick="changePenalites(1)">+</button>
                            </div>
                            <span class="counter-value" id="penalites-count">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pause-notice" class="pause-notice hidden">
                üö∂ PAUSE MARCHE
            </div>
        </div>

        <!-- Page 6: Bilan Interm√©diaire -->
        <div id="page-bilan" class="page hidden">
            <button class="btn-home" onclick="confirmHome()">üè† Accueil</button>
            <h2>üìä Bilan Interm√©diaire</h2>

            <div class="graph-container">
                <canvas id="chart-course1"></canvas>
            </div>

            <div class="result-card">
                <div class="result-item">
                    <span class="result-label">Sorties de route</span>
                    <span class="result-value" id="sorties-route">0</span>
                </div>
                <div class="result-item">
                    <span class="result-label">P√©nalit√©s totales</span>
                    <span class="result-value" id="penalites-total">0</span>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="nextPage('page-objectif')">Suivant</button>
            </div>
        </div>

        <!-- Page 7: Objectif Course 2 -->
        <div id="page-objectif" class="page hidden">
            <button class="btn-home" onclick="confirmHome()">üè† Accueil</button>
            <h2>üéØ Course Intermittente 30"/30"</h2>

            <div class="info-box">
                <strong>Demi-plots cible par 30":</strong> <span id="demi-plots-cible">8</span>
            </div>

            <div class="info-box">
                <strong>Sorties de route + P√©nalit√©s:</strong> <span id="total-erreurs">0</span>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                    Vous devez faire 4 courses de 30"/30" obligatoires.<br>
                    Vous pouvez faire des rattrapages suppl√©mentaires (max 4).<br>
                    Chaque rattrapage valid√© efface une sortie de route ou p√©nalit√©.
                </p>
            </div>

            <div class="input-group">
                <label for="nombre-rattrapages">Nombre de 30"/30" suppl√©mentaires (rattrapages)</label>
                <select id="nombre-rattrapages">
                    <option value="0">0 - Pas de rattrapage</option>
                    <option value="1">1 rattrapage</option>
                    <option value="2">2 rattrapages</option>
                    <option value="3">3 rattrapages</option>
                    <option value="4">4 rattrapages</option>
                </select>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="prevPage('page-bilan')">Retour</button>
                <button class="btn-primary" onclick="startCourse2Observation()">Commencer</button>
            </div>
        </div>

        <!-- Page 8: Observation Course 2 -->
        <div id="page-observation2" class="page hidden">
            <button class="btn-home" onclick="confirmHome()">üè† Accueil</button>
            
            <div class="chrono" id="chrono2">00:00</div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="start-chrono2-btn" class="btn-primary" onclick="startChronoManually('chrono2', 2)">‚ñ∂Ô∏è D√©marrer le chronom√®tre</button>
            </div>
            
            <div class="intermittent-counter">
                <div><strong>30"/30" obligatoires:</strong> <span id="obligatoire-count">1</span>/4</div>
                <div style="margin-top: 10px;"><strong>Rattrapages:</strong> <span id="rattrapage-count">0</span></div>
            </div>

            <div id="observation-content2">
                <div class="observation-panel">
                    <div class="info-box">
                        <strong>Demi-plots cible:</strong> <span id="demi-plots-cible2">8</span>
                    </div>

                    <div class="counter-group">
                        <span class="result-label">1/2 Plots franchis</span>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="counter-buttons">
                                <button class="btn-counter btn-minus" onclick="changeDemiPlots(-1)">‚àí</button>
                                <button class="btn-counter btn-plus" onclick="changeDemiPlots(1)">+</button>
                            </div>
                            <span class="counter-value" id="demi-plots-count">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pause-notice2" class="pause-notice hidden">
                üö∂ PAUSE MARCHE
            </div>
        </div>

        <!-- Page 9: R√©sultats Finaux -->
        <div id="page-resultats" class="page hidden">
            <h2>üèÜ R√©sultats Finaux</h2>

            <div class="result-card">
                <h3 style="color: #764ba2; margin-bottom: 15px;">Informations</h3>
                <div class="result-item">
                    <span class="result-label">Coureur</span>
                    <span class="result-value" id="result-coureur"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">VMA</span>
                    <span class="result-value" id="result-vma"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">Observateur</span>
                    <span class="result-value" id="result-observateur"></span>
                </div>
            </div>

            <div class="graph-container">
                <h3 style="color: #764ba2; margin-bottom: 15px;">Course 1 - Allure Continue</h3>
                <canvas id="chart-final1"></canvas>
            </div>

            <div class="graph-container">
                <h3 style="color: #764ba2; margin-bottom: 15px;">Course 2 - Intermittente 30"/30"</h3>
                <canvas id="chart-final2"></canvas>
            </div>

            <div class="result-card">
                <h3 style="color: #764ba2; margin-bottom: 15px;">Score Final</h3>
                <div class="result-item">
                    <span class="result-label">Sorties de route</span>
                    <span class="result-value" id="final-sorties"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">P√©nalit√©s</span>
                    <span class="result-value" id="final-penalites"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">Rattrapages valid√©s</span>
                    <span class="result-value" id="final-rattrapages"></span>
                </div>
                <div class="result-item" style="border-top: 3px solid #667eea; padding-top: 15px; margin-top: 15px;">
                    <span class="result-label" style="font-size: 20px;">Score Total</span>
                    <span class="result-value" style="font-size: 24px;" id="final-score"></span>
                </div>
            </div>

            <div id="message-final"></div>

            <div class="button-group">
                <button class="btn-secondary" onclick="exportPDF()">üìÑ Export PDF</button>
                <button class="btn-secondary" onclick="exportXLS()">üìä Export Excel</button>
            </div>

            <div class="button-group" style="margin-top: 10px;">
                <button class="btn-primary" onclick="resetApp()">Fin / Retour √† l'accueil</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #764ba2; margin-bottom: 20px;">‚ö†Ô∏è Confirmation</h3>
            <p>Voulez-vous vraiment retourner √† l'accueil ? Toutes les donn√©es seront perdues.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn-primary" onclick="resetApp()">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let appData = {
            coureur: '',
            vma: 0,
            observateur: '',
            badge: 0,
            allure: '',
            pauses: [],
            course1: {
                tranches: [],
                currentTranche: 0,
                plots: 0,
                penalites: 0
            },
            course2: {
                sequences: [],
                currentSequence: 0,
                demiPlots: 0,
                obligatoires: 0,
                rattrapages: 0
            }
        };

        let chronoInterval = null;
        let chronoSeconds = 0;
        let chronoStartTime = null;
        let chronoRunning = false;
        let trancheTimeout = null;
        let isInPause = false;

        // Navigation
        function nextPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function prevPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function confirmHome() {
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function resetApp() {
            closeModal();
            stopChrono();
            appData = {
                coureur: '',
                vma: 0,
                observateur: '',
                badge: 0,
                allure: '',
                pauses: [],
                course1: {
                    tranches: [],
                    currentTranche: 0,
                    plots: 0,
                    penalites: 0
                },
                course2: {
                    sequences: [],
                    currentSequence: 0,
                    demiPlots: 0,
                    obligatoires: 0,
                    rattrapages: 0
                }
            };
            document.getElementById('coureur').value = '';
            document.getElementById('vma').value = '';
            document.getElementById('observateur').value = '';
            nextPage('page-accueil');
        }

        // S√©lection du badge
        function selectBadge(badge) {
            appData.badge = badge;
            document.querySelectorAll('.badge-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.badge-card').classList.add('selected');

            // Masquer l'allure orange pour badge 6 min
            if (badge === 6) {
                document.getElementById('allure-orange').style.display = 'none';
            } else {
                document.getElementById('allure-orange').style.display = 'block';
            }
        }

        // S√©lection de l'allure
        function selectAllure(allure) {
            appData.allure = allure;
            document.querySelectorAll('.allure-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.allure-card').classList.add('selected');
        }

        function handleAllureNext() {
            if (!appData.badge) {
                alert('Veuillez s√©lectionner un badge');
                return;
            }
            if (!appData.allure) {
                alert('Veuillez s√©lectionner une allure');
                return;
            }

            appData.coureur = document.getElementById('coureur').value;
            appData.vma = parseFloat(document.getElementById('vma').value);
            appData.observateur = document.getElementById('observateur').value;

            if (!appData.coureur || !appData.vma || !appData.observateur) {
                alert('Veuillez remplir tous les champs de l\'accueil');
                nextPage('page-accueil');
                return;
            }

            if (appData.allure === 'verte') {
                appData.pauses = [];
                startCourse();
            } else {
                setupPauseSelection();
                nextPage('page-pauses');
            }
        }

        // Configuration des pauses
        function setupPauseSelection() {
            const numTranches = appData.badge / 1.5;
            const numPauses = appData.allure === 'jaune' ? 1 : 2;
            
            const container = document.getElementById('pause-bars');
            container.innerHTML = '';

            for (let i = 1; i <= numTranches; i++) {
                const bar = document.createElement('div');
                bar.className = 'pause-bar';
                bar.textContent = `Tranche ${i}`;
                bar.onclick = () => togglePause(i, numPauses);
                container.appendChild(bar);
            }
        }

        function togglePause(tranche, maxPauses) {
            const bars = document.querySelectorAll('.pause-bar');
            const bar = bars[tranche - 1];
            
            if (bar.classList.contains('pause')) {
                bar.classList.remove('pause');
                bar.textContent = `Tranche ${tranche}`;
                appData.pauses = appData.pauses.filter(p => p !== tranche);
            } else {
                if (appData.pauses.length < maxPauses) {
                    bar.classList.add('pause');
                    bar.textContent = 'PAUSE';
                    appData.pauses.push(tranche);
                } else {
                    alert(`Vous ne pouvez s√©lectionner que ${maxPauses} pause(s)`);
                }
            }
        }

        // Course 1
        function startCourse() {
            const maxPauses = appData.allure === 'jaune' ? 1 : appData.allure === 'orange' ? 2 : 0;
            if (appData.allure !== 'verte' && appData.pauses.length !== maxPauses) {
                alert(`Veuillez s√©lectionner ${maxPauses} pause(s)`);
                return;
            }

            const numTranches = appData.badge / 1.5;
            const plotsCible = appData.vma - (appData.allure === 'verte' ? 3 : appData.allure === 'jaune' ? 2 : 1);

            for (let i = 1; i <= numTranches; i++) {
                appData.course1.tranches.push({
                    numero: i,
                    isPause: appData.pauses.includes(i),
                    plotsCible: plotsCible,
                    plots: 0,
                    penalites: 0,
                    vitesse: 0
                });
            }

            document.getElementById('tranche-total').textContent = numTranches;
            document.getElementById('plots-cible').textContent = plotsCible;

            appData.course1.currentTranche = 0;
            
            // R√©initialiser l'√©tat du chronom√®tre
            chronoRunning = false;
            document.getElementById('start-chrono1-btn').style.display = 'block';
            document.getElementById('chrono1').textContent = '00:00';
            
            nextPage('page-observation1');
            // Ne pas d√©marrer automatiquement - attendre le clic sur le bouton
        }

        function startChrono(chronoId) {
            if (chronoRunning) return;
            
            chronoStartTime = Date.now();
            chronoSeconds = 0;
            chronoRunning = true;
            
            chronoInterval = setInterval(() => {
                if (!chronoRunning) return;
                
                // Calculer le temps √©coul√© bas√© sur l'horodatage
                const elapsed = Math.floor((Date.now() - chronoStartTime) / 1000);
                chronoSeconds = elapsed;
                
                const minutes = Math.floor(chronoSeconds / 60);
                const seconds = chronoSeconds % 60;
                document.getElementById(chronoId).textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 100); // Mise √† jour plus fr√©quente pour plus de pr√©cision
        }

        function startChronoManually(chronoId, courseNum) {
            if (chronoRunning) return;
            
            // Masquer le bouton de d√©marrage
            document.getElementById(`start-chrono${courseNum}-btn`).style.display = 'none';
            
            startChrono(chronoId);
            
            if (courseNum === 1) {
                updateTranche();
            } else {
                start3030();
            }
        }

        function stopChrono() {
            chronoRunning = false;
            if (chronoInterval) {
                clearInterval(chronoInterval);
                chronoInterval = null;
            }
            if (trancheTimeout) {
                clearTimeout(trancheTimeout);
                trancheTimeout = null;
            }
            chronoStartTime = null;
        }

        function updateTranche() {
            if (appData.course1.currentTranche >= appData.course1.tranches.length) {
                finishCourse1();
                return;
            }

            const tranche = appData.course1.tranches[appData.course1.currentTranche];
            document.getElementById('tranche-num').textContent = tranche.numero;

            if (tranche.isPause) {
                isInPause = true;
                document.getElementById('observation-content').classList.add('hidden');
                document.getElementById('pause-notice').classList.remove('hidden');
            } else {
                isInPause = false;
                document.getElementById('observation-content').classList.remove('hidden');
                document.getElementById('pause-notice').classList.add('hidden');
                appData.course1.plots = 0;
                appData.course1.penalites = 0;
                document.getElementById('plots-count').textContent = 0;
                document.getElementById('penalites-count').textContent = 0;
            }

            trancheTimeout = setTimeout(() => {
                saveTranche();
                appData.course1.currentTranche++;
                updateTranche();
            }, 90000); // 90 secondes = 1min30
        }

        function saveTranche() {
            const tranche = appData.course1.tranches[appData.course1.currentTranche];
            if (!tranche.isPause) {
                tranche.plots = appData.course1.plots;
                tranche.penalites = appData.course1.penalites;
                tranche.vitesse = appData.course1.plots; // 1 plot = 1 km/h
            }
        }

        function changePlots(delta) {
            if (isInPause) return;
            appData.course1.plots = Math.max(0, appData.course1.plots + delta);
            document.getElementById('plots-count').textContent = appData.course1.plots;
        }

        function changePenalites(delta) {
            if (isInPause) return;
            appData.course1.penalites = Math.max(0, appData.course1.penalites + delta);
            document.getElementById('penalites-count').textContent = appData.course1.penalites;
        }

        function finishCourse1() {
            stopChrono();
            
            // Calculer les sorties de route
            let sortiesRoute = 0;
            let penalitesTotal = 0;
            
            appData.course1.tranches.forEach(t => {
                if (!t.isPause) {
                    const manque = Math.max(0, t.plotsCible - t.plots);
                    sortiesRoute += manque;
                    penalitesTotal += t.penalites;
                }
            });

            document.getElementById('sorties-route').textContent = sortiesRoute;
            document.getElementById('penalites-total').textContent = penalitesTotal;

            // Cr√©er le graphique
            createChart1();
            
            nextPage('page-bilan');
        }

        function createChart1() {
            const ctx = document.getElementById('chart-course1').getContext('2d');
            
            const labels = appData.course1.tranches.map(t => `T${t.numero}`);
            const vitesses = appData.course1.tranches.map(t => t.isPause ? null : t.vitesse);
            const cibles = appData.course1.tranches.map(t => t.isPause ? null : t.plotsCible);

            if (window.chart1) {
                window.chart1.destroy();
            }

            window.chart1 = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Vitesse r√©elle (km/h)',
                            data: vitesses,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'Vitesse cible (km/h)',
                            data: cibles,
                            borderColor: '#51cf66',
                            borderDash: [5, 5],
                            tension: 0,
                            spanGaps: true,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Vitesse (km/h)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tranches'
                            }
                        }
                    }
                }
            });
        }

        // Course 2 - Intermittente
        function startCourse2() {
            // Calculer les demi-plots cibles selon la VMA et le badge
            let pourcentageVMA = 100;
            if (appData.badge === 9) pourcentageVMA = 110;
            if (appData.badge === 12) pourcentageVMA = 120;

            const vmaAjustee = appData.vma * (pourcentageVMA / 100);
            
            // Formule bas√©e sur les donn√©es fournies
            let demiPlotsCible;
            if (vmaAjustee <= 11) {
                demiPlotsCible = 7;
            } else if (vmaAjustee <= 12) {
                demiPlotsCible = 8;
            } else if (vmaAjustee <= 13) {
                demiPlotsCible = 9;
            } else if (vmaAjustee <= 15) {
                demiPlotsCible = 10;
            } else if (vmaAjustee <= 17) {
                demiPlotsCible = 11;
            } else {
                demiPlotsCible = 12;
            }

            document.getElementById('demi-plots-cible').textContent = demiPlotsCible;
            document.getElementById('demi-plots-cible2').textContent = demiPlotsCible;

            // Calculer le total: sorties de route + p√©nalit√©s
            const sortiesRoute = parseInt(document.getElementById('sorties-route').textContent);
            const penalites = parseInt(document.getElementById('penalites-total').textContent);
            const totalErreurs = sortiesRoute + penalites;
            
            document.getElementById('total-erreurs').textContent = totalErreurs;

            // Configurer le s√©lecteur de rattrapages (max 4)
            const maxRattrapages = Math.min(4, totalErreurs);
            const selectRattrapages = document.getElementById('nombre-rattrapages');
            selectRattrapages.innerHTML = '<option value="0">0 - Pas de rattrapage</option>';
            for (let i = 1; i <= maxRattrapages; i++) {
                selectRattrapages.innerHTML += `<option value="${i}">${i} rattrapage${i > 1 ? 's' : ''}</option>`;
            }

            appData.course2.demiPlotsCible = demiPlotsCible;
            appData.course2.totalErreurs = totalErreurs;

            nextPage('page-objectif');
        }

        function startCourse2Observation() {
            // R√©cup√©rer le nombre de rattrapages choisis
            const nombreRattrapagesChoisis = parseInt(document.getElementById('nombre-rattrapages').value);
            const totalCourses = 4 + nombreRattrapagesChoisis; // 4 obligatoires + rattrapages
            
            nextPage('page-observation2');
            
            // R√©initialiser l'√©tat du chronom√®tre
            chronoRunning = false;
            document.getElementById('start-chrono2-btn').style.display = 'block';
            document.getElementById('chrono2').textContent = '00:00';
            
            appData.course2.sequences = [];
            appData.course2.currentSequence = 0;
            appData.course2.obligatoires = 0;
            appData.course2.rattrapages = 0;
            appData.course2.demiPlots = 0;
            appData.course2.phase = 'waiting'; // 'waiting', 'course', 'pause'
            appData.course2.totalCoursesAProgrammer = totalCourses;
            appData.course2.nombreRattrapagesChoisis = nombreRattrapagesChoisis;
            
            document.getElementById('demi-plots-count').textContent = 0;
            document.getElementById('obligatoire-count').textContent = '0';
            document.getElementById('rattrapage-count').textContent = '0';
            
            // Masquer tout au d√©but
            document.getElementById('observation-content2').classList.add('hidden');
            document.getElementById('pause-notice2').classList.add('hidden');
        }

        function start3030() {
            // D√©marrer une nouvelle s√©quence de course de 30"
            appData.course2.demiPlots = 0;
            document.getElementById('demi-plots-count').textContent = 0;
            appData.course2.phase = 'course';
            
            // Afficher la partie observation (comptage des demi-plots)
            document.getElementById('observation-content2').classList.remove('hidden');
            document.getElementById('pause-notice2').classList.add('hidden');
            
            // Surveiller le chronom√®tre pour passer en pause au bon moment
            surveillerChronometre();
        }

        function surveillerChronometre() {
            // V√©rifier toutes les 100ms o√π on en est dans le chronom√®tre
            const intervalCheck = setInterval(() => {
                if (!chronoRunning) {
                    clearInterval(intervalCheck);
                    return;
                }
                
                const secondes = chronoSeconds;
                const courseNum = appData.course2.obligatoires + appData.course2.rattrapages;
                
                // Plages de COURSE : 0-30s, 60-90s, 120-150s, 180-210s, 240-270s, 300-330s, 360-390s, 420-450s
                // Plages de PAUSE : 30-60s, 90-120s, 150-180s, 210-240s, 270-300s, 330-360s, 390-420s, 450-480s
                
                const cyclePosition = secondes % 60; // Position dans le cycle de 60 secondes
                
                if (appData.course2.phase === 'course' && cyclePosition >= 30) {
                    // On vient de d√©passer 30 secondes, passer en pause
                    clearInterval(intervalCheck);
                    passerEnPause();
                } else if (appData.course2.phase === 'pause' && cyclePosition < 30 && secondes > 30) {
                    // On vient de commencer un nouveau cycle de 60s (nouveau 30/30)
                    // V√©rifier si on doit continuer
                    const coursesEffectuees = appData.course2.sequences.length;
                    if (coursesEffectuees < appData.course2.totalCoursesAProgrammer) {
                        clearInterval(intervalCheck);
                        start3030();
                    } else {
                        // Toutes les courses sont termin√©es
                        clearInterval(intervalCheck);
                        finishCourse2();
                    }
                }
            }, 100);
        }

        function passerEnPause() {
            // Sauvegarder les donn√©es de cette course
            const coursesObligatoiresFaites = appData.course2.sequences.filter(s => !s.isRattrapage).length;
            const isRattrapage = coursesObligatoiresFaites >= 4;
            const demiPlotsRealises = appData.course2.demiPlots;
            const valide = demiPlotsRealises >= appData.course2.demiPlotsCible;
            
            appData.course2.sequences.push({
                demiPlots: demiPlotsRealises,
                cible: appData.course2.demiPlotsCible,
                valide: valide,
                isRattrapage: isRattrapage
            });
            
            // Mettre √† jour les compteurs
            if (!isRattrapage) {
                appData.course2.obligatoires++;
                document.getElementById('obligatoire-count').textContent = appData.course2.obligatoires;
            } else {
                appData.course2.rattrapages++;
                document.getElementById('rattrapage-count').textContent = appData.course2.rattrapages;
            }
            
            // Passer en mode pause
            appData.course2.phase = 'pause';
            document.getElementById('observation-content2').classList.add('hidden');
            
            const pauseNotice = document.getElementById('pause-notice2');
            
            // V√©rifier si c'est la derni√®re course
            const coursesEffectuees = appData.course2.sequences.length;
            if (coursesEffectuees >= appData.course2.totalCoursesAProgrammer) {
                // Derni√®re course, afficher bouton de fin
                pauseNotice.innerHTML = `
                    üö∂ PAUSE MARCHE
                    <div style="margin-top: 20px;">
                        <button class="btn-primary" style="padding: 15px 30px;" onclick="finishCourse2()">Terminer</button>
                    </div>
                `;
            } else {
                // Pas encore fini, juste afficher la pause
                pauseNotice.innerHTML = 'üö∂ PAUSE MARCHE';
            }
            
            pauseNotice.classList.remove('hidden');
            
            // Continuer la surveillance pour la prochaine course
            if (coursesEffectuees < appData.course2.totalCoursesAProgrammer) {
                surveillerChronometre();
            }
        }

        function changeDemiPlots(delta) {
            if (appData.course2.phase !== 'course') return;
            appData.course2.demiPlots = Math.max(0, appData.course2.demiPlots + delta);
            document.getElementById('demi-plots-count').textContent = appData.course2.demiPlots;
        }

        function finishCourse2() {
            stopChrono();
            showFinalResults();
        }

        function showFinalResults() {
            // Remplir les informations
            document.getElementById('result-coureur').textContent = appData.coureur;
            document.getElementById('result-vma').textContent = appData.vma + ' km/h';
            document.getElementById('result-observateur').textContent = appData.observateur;

            // Calculer les sorties de route de la course 1
            let sortiesRoute1 = 0;
            appData.course1.tranches.forEach(t => {
                if (!t.isPause) {
                    sortiesRoute1 += Math.max(0, t.plotsCible - t.plots);
                }
            });

            // Calculer les sorties de route de la course 2 (seulement les 4 obligatoires)
            let sortiesRoute2 = 0;
            appData.course2.sequences.forEach(s => {
                if (!s.isRattrapage) {
                    sortiesRoute2 += Math.max(0, s.cible - s.demiPlots);
                }
            });

            // Calculer le total des p√©nalit√©s
            let penalitesTotal = 0;
            appData.course1.tranches.forEach(t => {
                penalitesTotal += t.penalites;
            });

            // Compter les rattrapages valid√©s
            let rattrapagesValides = 0;
            appData.course2.sequences.forEach(s => {
                if (s.isRattrapage && s.valide) {
                    rattrapagesValides++;
                }
            });

            // Calculer le score final: sorties de route totales + p√©nalit√©s - rattrapages valid√©s
            const sortiesTotal = sortiesRoute1 + sortiesRoute2;
            const scoreAvantRattrapages = sortiesTotal + penalitesTotal;
            const scoreFinal = Math.max(0, scoreAvantRattrapages - rattrapagesValides);

            document.getElementById('final-sorties').textContent = sortiesTotal;
            document.getElementById('final-penalites').textContent = penalitesTotal;
            document.getElementById('final-rattrapages').textContent = rattrapagesValides;
            document.getElementById('final-score').textContent = scoreFinal;

            // Message bas√© sur le score final
            const messageDiv = document.getElementById('message-final');
            if (scoreFinal <= 1) {
                messageDiv.className = 'message-box message-success';
                messageDiv.textContent = 'üéâ BRAVO ! üéâ';
            } else {
                messageDiv.className = 'message-box message-retry';
                messageDiv.textContent = 'C\'est pas grave, retente ta chance ! üí™';
            }

            // Graphiques
            createFinalCharts();
            
            nextPage('page-resultats');
        }

        function createFinalCharts() {
            // Graphique Course 1
            const ctx1 = document.getElementById('chart-final1').getContext('2d');
            const labels1 = appData.course1.tranches.map(t => `T${t.numero}`);
            const vitesses1 = appData.course1.tranches.map(t => t.isPause ? null : t.vitesse);
            const cibles1 = appData.course1.tranches.map(t => t.isPause ? null : t.plotsCible);

            if (window.chartFinal1) {
                window.chartFinal1.destroy();
            }

            window.chartFinal1 = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels1,
                    datasets: [
                        {
                            label: 'Vitesse r√©elle',
                            data: vitesses1,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'Vitesse cible',
                            data: cibles1,
                            borderColor: '#51cf66',
                            borderDash: [5, 5],
                            tension: 0,
                            spanGaps: true,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Vitesse (km/h)'
                            }
                        }
                    }
                }
            });

            // Graphique Course 2
            const ctx2 = document.getElementById('chart-final2').getContext('2d');
            const labels2 = appData.course2.sequences.map((s, i) => 
                s.isRattrapage ? `R${i - 3}` : `${i + 1}`
            );
            const demiPlots = appData.course2.sequences.map(s => s.demiPlots);
            const cibles2 = appData.course2.sequences.map(s => s.cible);

            if (window.chartFinal2) {
                window.chartFinal2.destroy();
            }

            window.chartFinal2 = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels2,
                    datasets: [
                        {
                            label: '1/2 Plots r√©alis√©s',
                            data: demiPlots,
                            backgroundColor: appData.course2.sequences.map(s => 
                                s.valide ? 'rgba(81, 207, 102, 0.7)' : 'rgba(255, 107, 107, 0.7)'
                            ),
                            borderColor: appData.course2.sequences.map(s => 
                                s.valide ? '#51cf66' : '#ff6b6b'
                            ),
                            borderWidth: 2
                        },
                        {
                            label: '1/2 Plots cible',
                            data: cibles2,
                            type: 'line',
                            borderColor: '#667eea',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '1/2 Plots'
                            }
                        }
                    }
                }
            });
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text('Champion de sa Course - R√©sultats', 20, 20);

            doc.setFontSize(12);
            doc.text(`Coureur: ${appData.coureur}`, 20, 35);
            doc.text(`VMA: ${appData.vma} km/h`, 20, 42);
            doc.text(`Observateur: ${appData.observateur}`, 20, 49);
            doc.text(`Badge: ${appData.badge} min`, 20, 56);
            doc.text(`Allure: ${appData.allure}`, 20, 63);

            doc.text('Score Final:', 20, 77);
            const score = parseInt(document.getElementById('final-score').textContent);
            doc.text(`Sorties de route: ${document.getElementById('final-sorties').textContent}`, 20, 84);
            doc.text(`P√©nalit√©s: ${document.getElementById('final-penalites').textContent}`, 20, 91);
            doc.text(`Rattrapages valid√©s: ${document.getElementById('final-rattrapages').textContent}`, 20, 98);
            doc.text(`Score total: ${score}`, 20, 105);

            doc.setFontSize(14);
            if (score <= 1) {
                doc.text('BRAVO !', 20, 119);
            } else {
                doc.text('C\'est pas grave, retente ta chance !', 20, 119);
            }

            doc.save('resultats-course.pdf');
        }

        function exportXLS() {
            const wb = XLSX.utils.book_new();

            // Feuille 1: Informations g√©n√©rales
            const wsData1 = [
                ['Champion de sa Course - R√©sultats'],
                [],
                ['Coureur', appData.coureur],
                ['VMA', appData.vma + ' km/h'],
                ['Observateur', appData.observateur],
                ['Badge', appData.badge + ' min'],
                ['Allure', appData.allure],
                [],
                ['Score Final'],
                ['Sorties de route', document.getElementById('final-sorties').textContent],
                ['P√©nalit√©s', document.getElementById('final-penalites').textContent],
                ['Rattrapages valid√©s', document.getElementById('final-rattrapages').textContent],
                ['Score total', document.getElementById('final-score').textContent]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(wsData1);
            XLSX.utils.book_append_sheet(wb, ws1, 'R√©sultats');

            // Feuille 2: Course 1
            const wsData2 = [['Tranche', 'Type', 'Plots cible', 'Plots r√©alis√©s', 'P√©nalit√©s', 'Vitesse']];
            appData.course1.tranches.forEach(t => {
                wsData2.push([
                    t.numero,
                    t.isPause ? 'Pause' : 'Course',
                    t.isPause ? '-' : t.plotsCible,
                    t.isPause ? '-' : t.plots,
                    t.isPause ? '-' : t.penalites,
                    t.isPause ? '-' : t.vitesse
                ]);
            });
            const ws2 = XLSX.utils.aoa_to_sheet(wsData2);
            XLSX.utils.book_append_sheet(wb, ws2, 'Course 1');

            // Feuille 3: Course 2
            const wsData3 = [['S√©quence', 'Type', '1/2 Plots cible', '1/2 Plots r√©alis√©s', 'Valid√©']];
            appData.course2.sequences.forEach((s, i) => {
                wsData3.push([
                    i + 1,
                    s.isRattrapage ? 'Rattrapage' : 'Obligatoire',
                    s.cible,
                    s.demiPlots,
                    s.valide ? 'Oui' : 'Non'
                ]);
            });
            const ws3 = XLSX.utils.aoa_to_sheet(wsData3);
            XLSX.utils.book_append_sheet(wb, ws3, 'Course 2');

            XLSX.writeFile(wb, 'resultats-course.xlsx');
        }

        // Initialisation au d√©marrage de la page observation 2
        document.addEventListener('DOMContentLoaded', function() {
            // Rien √† initialiser au d√©marrage
        });
    </script>
</body>
</html>
